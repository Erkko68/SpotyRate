{% extends "base.html" %}
{% load static %}

{% block title %}SpotyRate | Dashboard{% endblock %}

{% block header_extra %}
    {%include 'header/search_bar.html' %}
    <div class="flex-1"></div>
    {% include 'header/user_pfp.html' %}
{% endblock %}


{% block content %}
<div class="flex-1 flex px-4 p-4 bg-[var(--color-spotify-black)]">
    <div class="gap-4 flex-1 min-h-0">
        <div class="grid grid-cols-15 gap-4 min-h-0 h-full">
            <!-- Left Sidebar -->
            <div class="col-span-3 bg-[var(--color-spotify-dark)] rounded-lg p-4">
                Left
            </div>

            <!-- Main Content -->
            <div id="main-content" class="col-span-12 bg-[var(--color-spotify-dark)] rounded-lg overflow-auto">
                <div class="text-white">
                    <h2 class="text-2xl font-bold mb-4">Your Dashboard</h2>
                    <p>Default content goes here...</p>
                </div>
            </div>

            <!-- Right Sidebar (If no content is present, it disappears) -->
            <div id="right-sidebar-container" class="col-span-4 bg-[var(--color-spotify-dark)] rounded-lg hidden">

            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const mainContent = document.getElementById('main-content');

    // Centralized fetch & render
    async function fetchAndRender(url) {
      try {
        const res = await fetch(url, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error(res.status);
        const html = await res.text();
        mainContent.innerHTML = html;

        bindSearchResultsClick();
      } catch (err) {
        console.error('Fetch error:', err);
        mainContent.innerHTML = `
          <div class="p-4 text-center text-red-300">
            Something went wrong. Please try again.
          </div>`;
      }
    }

    // Handle search events
    document.addEventListener('searchQuery', e => {
      const { query } = e.detail;
      const url = `/search/?q=${encodeURIComponent(query)}`;
      fetchAndRender(url);
    });

    // Handle item navigation (tracks, playlists, albums, artists)
    document.addEventListener('navigate', e => {
      const { type, id } = e.detail;
      const url = `/dashboard/media/?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}`;
      fetchAndRender(url);
    });

    // Bind click events for search results
    function bindSearchResultsClick() {
      const container = document.getElementById('search-results');
      if (!container) return;

      container.addEventListener('click', e => {
        const item = e.target.closest('.result-item');
        if (!item) return;

        const type = item.dataset.type;
        const id = item.dataset.id;

        document.dispatchEvent(new CustomEvent('navigate', {
          detail: { type, id }
        }));
      });
    }

    // Function to update the right sidebar content and adjust layout
    function updateRightSidebar(content) {
        // Select the right sidebar and the main content area
        const sidebar = document.getElementById("right-sidebar");
        const mainContent = document.getElementById("main-content");

        // If content is provided, update the right sidebar and show it
        if (content) {
            sidebar.innerHTML = content;  // Inject the new content into the sidebar
            sidebar.classList.remove("hidden");  // Show the sidebar
            mainContent.classList.remove("col-span-12");  // Adjust main content width
            mainContent.classList.add("col-span-8");  // Main content will take up 8 columns
        } else {
            // If no content, hide the sidebar
            sidebar.classList.add("hidden");
            mainContent.classList.remove("col-span-8");  // Adjust back to full width
            mainContent.classList.add("col-span-12");  // Main content takes up 12 columns
        }
    }


    // Initial binding
    bindSearchResultsClick();
  });
</script>
{% endblock %}
